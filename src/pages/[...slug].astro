---
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import PostLayout from '@layouts/PostLayout.astro';
import * as MarkdownComponents from '@layouts/components/MarkdownComponents.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const pages = await getCollection('pages');

  const postPaths = posts.map((post) => {
    const slug = post.data.canonical
      ? new URL(post.data.canonical).pathname.split('/').filter(Boolean).pop() ?? post.slug
      : post.slug;

    return {
      params: { slug },
      props: { entry: post, collection: 'posts' as const },
    };
  });

  const pagePaths = pages
    .map((page) => {
      if (!page.slug) return null;
      const normalizedSlug = page.slug.replace(/^\/+|\/+$/g, '');
      if (!normalizedSlug || normalizedSlug === 'home' || normalizedSlug === '404') return null;
      return {
        params: { slug: normalizedSlug },
        props: { entry: page, collection: 'pages' as const },
      };
    })
    .filter((entry): entry is NonNullable<typeof entry> => Boolean(entry));

  return [...postPaths, ...pagePaths];
}

const { entry, collection } = Astro.props;
let title = '';
let description = '';
let image: string | undefined;
let Content;
let headings;

if (collection === 'posts') {
  const rendered = await entry.render();
  ({ Content, headings } = rendered);
} else {
  const rendered = await entry.render();
  ({ Content } = rendered);
  ({ title = '', description = '', image } = entry.data);
}
---

{collection === 'posts' ? (
  <PostLayout post={entry} headings={headings}>
    <Content components={MarkdownComponents} />
  </PostLayout>
) : (
  <Layout title={title} description={description} image={image}>
    <section class="py-12">
      <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
        <header class="mb-10">
          <h1 class="text-3xl font-bold text-brand-navy sm:text-4xl">{title}</h1>
        </header>
        <div class="prose prose-lg text-brand-navy/90 dark:prose-invert max-w-none">
          <Content components={MarkdownComponents} />
        </div>
      </div>
    </section>
  </Layout>
)}
